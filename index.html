<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Đếm búng tai – Cờ cá ngựa</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
    }
    h1, h2, h3 {
      margin: 0 0 8px;
    }
    .card {
      background: #ffffff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      margin-bottom: 16px;
    }
    label {
      font-size: 14px;
      font-weight: 500;
      display: block;
      margin-bottom: 4px;
    }
    input[type="text"], select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      padding: 6px 8px;
      text-align: center;
      font-size: 13px;
      border: 1px solid #e5e7eb;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
    }
    .btn {
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      background: #2563eb;
      color: white;
    }
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .col {
      flex: 1 1 180px;
      min-width: 150px;
    }
    .badge-color {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
    }
    .dot-red { background: #ef4444; }
    .dot-green { background: #22c55e; }
    .dot-blue { background: #3b82f6; }
    .dot-yellow { background: #eab308; }
    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      text-align: left;
    }
    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 8px;
    }
    .actions-row > div {
      flex: 1 1 260px;
      min-width: 240px;
    }
    .text-left { text-align: left; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Đếm búng tai – Cờ cá ngựa (4 người)</h1>
    <p class="hint">
      Đếm tổng số lần mỗi người bị búng tai, chi tiết “ai búng ai”, có cấn trừ ngược chiều và thưởng phạt khi xong trận.
    </p>
  </div>

  <!-- Cấu hình người chơi -->
  <div class="card">
    <h2>Cấu hình người chơi</h2>
    <div class="row">
      <div class="col">
        <label for="name1">Người chơi 1</label>
        <input type="text" id="name1" placeholder="Tên người chơi 1" />
      </div>
      <div class="col">
        <label for="color1">Màu</label>
        <select id="color1">
          <option value="red">Đỏ</option>
          <option value="green">Xanh lá</option>
          <option value="blue">Xanh dương</option>
          <option value="yellow">Vàng</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top: 8px;">
      <div class="col">
        <label for="name2">Người chơi 2</label>
        <input type="text" id="name2" placeholder="Tên người chơi 2" />
      </div>
      <div class="col">
        <label for="color2">Màu</label>
        <select id="color2">
          <option value="red">Đỏ</option>
          <option value="green">Xanh lá</option>
          <option value="blue">Xanh dương</option>
          <option value="yellow">Vàng</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top: 8px;">
      <div class="col">
        <label for="name3">Người chơi 3</label>
        <input type="text" id="name3" placeholder="Tên người chơi 3" />
      </div>
      <div class="col">
        <label for="color3">Màu</label>
        <select id="color3">
          <option value="red">Đỏ</option>
          <option value="green">Xanh lá</option>
          <option value="blue">Xanh dương</option>
          <option value="yellow">Vàng</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top: 8px;">
      <div class="col">
        <label for="name4">Người chơi 4</label>
        <input type="text" id="name4" placeholder="Tên người chơi 4" />
      </div>
      <div class="col">
        <label for="color4">Màu</label>
        <select id="color4">
          <option value="red">Đỏ</option>
          <option value="green">Xanh lá</option>
          <option value="blue">Xanh dương</option>
          <option value="yellow">Vàng</option>
        </select>
      </div>
    </div>

    <p class="hint" style="margin-top: 8px;">
      Gợi ý: mỗi màu nên chỉ dùng cho 1 người chơi.
    </p>

    <button class="btn" id="initGameBtn">Khởi tạo / Cập nhật người chơi</button>
    <button class="btn btn-secondary" id="resetCountsBtn" disabled>Reset toàn bộ</button>
  </div>

  <!-- Khu vực chơi -->
  <div id="gameArea" class="card" style="display:none;">
    <h2>Bảng tổng số lần bị búng tai</h2>
    <p class="hint">
      Tổng số lần mỗi người bị búng tai (sau khi đã cấn trừ qua lại).
    </p>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th class="text-left">Người chơi</th>
          <th>Màu</th>
          <th>Số lần bị búng tai</th>
        </tr>
      </thead>
      <tbody id="scoreBody"></tbody>
    </table>

    <h2 style="margin-top:16px;">Ma trận “ai búng tai ai” (đã cấn trừ)</h2>
    <p class="hint">
      Hàng là người <strong>búng</strong>, cột là người <strong>bị búng</strong>.  
      Ví dụ: nếu Vũ búng Huyền 3 lần, Huyền búng lại Vũ 1 lần, ma trận sẽ hiển thị Vũ → Huyền = 2, Huyền → Vũ = 0.
    </p>
    <table id="matrixTable">
      <thead id="matrixHead"></thead>
      <tbody id="matrixBody"></tbody>
    </table>

    <hr style="margin: 16px 0; border: none; border-top: 1px solid #e5e7eb;" />

    <h3 class="section-title">Các thao tác theo luật</h3>
    <p class="hint">
      Hệ thống sẽ tự cộng vào ma trận <strong>người búng → người bị búng</strong>, có cấn trừ ngược chiều.
    </p>

    <div class="actions-row">
      <!-- Quân về chuồng số 6 đầu tiên -->
      <div>
        <div class="section-title">1. Quân về chuồng số 6 đầu tiên</div>
        <p class="hint">
          Nếu một người có 1 quân về chuồng số 6 đầu tiên, thì
          <strong>3 người còn lại</strong> mỗi người bị +2 lần búng tai từ người đó.
        </p>
        <label for="firstHomeSelect">Người có quân về chuồng số 6 trước:</label>
        <select id="firstHomeSelect"></select>
        <button class="btn" id="firstHomeBtn" style="margin-top: 6px;">
          Áp dụng luật 1
        </button>
      </div>

      <!-- Đá trong chuồng chủ nhà -->
      <div>
        <div class="section-title">2. Đá tại chuồng của chủ nhà</div>
        <p class="hint">
          Ai đang đứng ở chuồng của người khác mà bị chính chủ <strong>đá</strong> thì bị +2 lần búng tai từ chủ chuồng.
        </p>
        <label>Người đá (chủ chuồng):</label>
        <select id="kickHomeAttacker"></select>

        <label style="margin-top: 6px;">Người bị đá (đang đứng trong chuồng đó):</label>
        <select id="kickHomeVictim"></select>

        <button class="btn" id="kickHomeBtn" style="margin-top: 6px;">
          Áp dụng luật 2 (+2)
        </button>
      </div>

      <!-- Đá ngoài chuồng -->
      <div>
        <div class="section-title">3. Đá ở vị trí bất kỳ ngoài chuồng</div>
        <p class="hint">
          Ai bị đá ở vị trí bất kỳ <strong>ngoài chuồng</strong> thì bị +1 lần búng tai từ người đá.
        </p>
        <label>Người đá:</label>
        <select id="kickNormalAttacker"></select>

        <label style="margin-top: 6px;">Người bị đá:</label>
        <select id="kickNormalVictim"></select>

        <button class="btn" id="kickNormalBtn" style="margin-top: 6px;">
          Áp dụng luật 3 (+1)
        </button>
      </div>
    </div>

    <hr style="margin: 16px 0; border: none; border-top: 1px solid #e5e7eb;" />

    <!-- Xong trận -->
    <h3 class="section-title">4. Xong trận – Xếp hạng 1, 2, 3, 4</h3>
    <p class="hint">
      Chọn thứ hạng cuối trận. Người đứng <strong>nhất</strong> sẽ búng người đứng
      <strong>nhì</strong> +3 lần, người đứng <strong>ba</strong> +4 lần, người đứng
      <strong>bốn</strong> +5 lần (cũng theo kiểu cấn trừ ngược chiều).
    </p>
    <div class="row">
      <div class="col">
        <label for="rank1Select">Hạng 1 (Nhất):</label>
        <select id="rank1Select"></select>
      </div>
      <div class="col">
        <label for="rank2Select">Hạng 2 (Nhì):</label>
        <select id="rank2Select"></select>
      </div>
    </div>
    <div class="row" style="margin-top: 8px;">
      <div class="col">
        <label for="rank3Select">Hạng 3 (Ba):</label>
        <select id="rank3Select"></select>
      </div>
      <div class="col">
        <label for="rank4Select">Hạng 4 (Bốn):</label>
        <select id="rank4Select"></select>
      </div>
    </div>
    <button class="btn" id="finishMatchBtn" style="margin-top: 8px;">
      Xong trận – Áp dụng thưởng phạt
    </button>
  </div>

  <script>
    // Danh sách người chơi
    const players = [];
    // Ma trận búng tai: flickMatrix[attackerIndex][victimIndex]
    let flickMatrix = [];

    function colorClass(color) {
      switch (color) {
        case "red": return "dot-red";
        case "green": return "dot-green";
        case "blue": return "dot-blue";
        case "yellow": return "dot-yellow";
        default: return "";
      }
    }

    function colorLabel(color) {
      switch (color) {
        case "red": return "Đỏ";
        case "green": return "Xanh lá";
        case "blue": return "Xanh dương";
        case "yellow": return "Vàng";
        default: return color;
      }
    }

    function initMatrix() {
      flickMatrix = [];
      for (let i = 0; i < 4; i++) {
        const row = [];
        for (let j = 0; j < 4; j++) {
          row.push(0);
        }
        flickMatrix.push(row);
      }
    }

    // Cộng búng tai có cấn trừ ngược chiều
    // attackerIndex búng victimIndex "amount" lần
    function addFlick(attackerIndex, victimIndex, amount) {
      if (attackerIndex === victimIndex || amount <= 0) return;

      let remain = amount;
      const opp = flickMatrix[victimIndex][attackerIndex]; // chiều ngược lại

      // Cấn trừ trước
      if (opp >= remain) {
        flickMatrix[victimIndex][attackerIndex] -= remain;
        remain = 0;
      } else {
        remain -= opp;
        flickMatrix[victimIndex][attackerIndex] = 0;
      }

      // Phần còn lại mới cộng vào chiều đúng
      if (remain > 0) {
        flickMatrix[attackerIndex][victimIndex] += remain;
      }
    }

    function initPlayers() {
      players.length = 0;

      const names = [
        document.getElementById("name1").value.trim() || "Người chơi 1",
        document.getElementById("name2").value.trim() || "Người chơi 2",
        document.getElementById("name3").value.trim() || "Người chơi 3",
        document.getElementById("name4").value.trim() || "Người chơi 4",
      ];
      const colors = [
        document.getElementById("color1").value,
        document.getElementById("color2").value,
        document.getElementById("color3").value,
        document.getElementById("color4").value,
      ];

      const colorSet = new Set(colors);
      if (colorSet.size < colors.length) {
        alert(
          "Lưu ý: Có ít nhất hai người trùng màu. Nếu muốn đúng luật cờ cá ngựa, hãy chỉnh lại cho mỗi người một màu khác nhau."
        );
      }

      for (let i = 0; i < 4; i++) {
        players.push({
          id: i + 1,
          name: names[i],
          color: colors[i],
        });
      }

      initMatrix();
      updateAllViews();
      populateSelects();
      document.getElementById("gameArea").style.display = "block";
      document.getElementById("resetCountsBtn").disabled = false;
    }

    // Tính tổng số lần mỗi người bị búng tai (theo cột)
    function getTotalsPerVictim() {
      const totals = [0, 0, 0, 0];
      for (let attacker = 0; attacker < 4; attacker++) {
        for (let victim = 0; victim < 4; victim++) {
          totals[victim] += flickMatrix[attacker][victim];
        }
      }
      return totals;
    }

    function updateScoreboard() {
      const tbody = document.getElementById("scoreBody");
      tbody.innerHTML = "";
      const totals = getTotalsPerVictim();

      players.forEach((p, index) => {
        const tr = document.createElement("tr");

        const tdIndex = document.createElement("td");
        tdIndex.textContent = index + 1;

        const tdName = document.createElement("td");
        tdName.textContent = p.name;
        tdName.className = "text-left";

        const tdColor = document.createElement("td");
        const span = document.createElement("span");
        span.className = "badge-color";
        span.innerHTML =
          '<span class="dot ' +
          colorClass(p.color) +
          '"></span>' +
          "<span>" +
          colorLabel(p.color) +
          "</span>";
        tdColor.appendChild(span);

        const tdTotal = document.createElement("td");
        tdTotal.textContent = totals[index];

        tr.appendChild(tdIndex);
        tr.appendChild(tdName);
        tr.appendChild(tdColor);
        tr.appendChild(tdTotal);

        tbody.appendChild(tr);
      });
    }

    function updateMatrixTable() {
      const head = document.getElementById("matrixHead");
      const body = document.getElementById("matrixBody");

      // Header
      head.innerHTML = "";
      const headRow = document.createElement("tr");
      const corner = document.createElement("th");
      corner.textContent = "Búng \\ Bị búng";
      headRow.appendChild(corner);

      players.forEach((p) => {
        const th = document.createElement("th");
        th.textContent = p.name;
        headRow.appendChild(th);
      });
      head.appendChild(headRow);

      // Body
      body.innerHTML = "";
      players.forEach((attacker, i) => {
        const tr = document.createElement("tr");

        const thName = document.createElement("th");
        thName.textContent = attacker.name;
        tr.appendChild(thName);

        players.forEach((victim, j) => {
          const td = document.createElement("td");
          if (i === j) {
            td.textContent = "-";
            td.style.color = "#9ca3af";
          } else {
            td.textContent = flickMatrix[i][j];
          }
          tr.appendChild(td);
        });

        body.appendChild(tr);
      });
    }

    function updateAllViews() {
      updateScoreboard();
      updateMatrixTable();
    }

    function populateSelect(selectId) {
      const sel = document.getElementById(selectId);
      if (!sel) return;
      sel.innerHTML = "";
      players.forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name + " (" + colorLabel(p.color) + ")";
        sel.appendChild(opt);
      });
    }

    function populateSelects() {
      populateSelect("firstHomeSelect");
      populateSelect("kickHomeAttacker");
      populateSelect("kickHomeVictim");
      populateSelect("kickNormalAttacker");
      populateSelect("kickNormalVictim");
      // Select xếp hạng cuối trận
      populateSelect("rank1Select");
      populateSelect("rank2Select");
      populateSelect("rank3Select");
      populateSelect("rank4Select");
    }

    function handleFirstHome() {
      const select = document.getElementById("firstHomeSelect");
      const id = parseInt(select.value, 10);
      if (!id) return;

      const attackerIndex = id - 1;
      for (let victimIndex = 0; victimIndex < 4; victimIndex++) {
        if (victimIndex !== attackerIndex) {
          addFlick(attackerIndex, victimIndex, 2);
        }
      }
      updateAllViews();
    }

    function handleKick(isHome) {
      const attackerSelect = isHome
        ? document.getElementById("kickHomeAttacker")
        : document.getElementById("kickNormalAttacker");
      const victimSelect = isHome
        ? document.getElementById("kickHomeVictim")
        : document.getElementById("kickNormalVictim");

      const attackerId = parseInt(attackerSelect.value, 10);
      const victimId = parseInt(victimSelect.value, 10);

      if (!attackerId || !victimId) return;

      if (attackerId === victimId) {
        alert("Người đá và người bị đá không thể là cùng một người.");
        return;
      }

      const attackerIndex = attackerId - 1;
      const victimIndex = victimId - 1;

      addFlick(attackerIndex, victimIndex, isHome ? 2 : 1);
      updateAllViews();
    }

    function handleFinishMatch() {
      const r1 = parseInt(document.getElementById("rank1Select").value, 10);
      const r2 = parseInt(document.getElementById("rank2Select").value, 10);
      const r3 = parseInt(document.getElementById("rank3Select").value, 10);
      const r4 = parseInt(document.getElementById("rank4Select").value, 10);

      const ids = [r1, r2, r3, r4];

      if (ids.some((id) => !id)) {
        alert("Vui lòng chọn đủ 4 vị trí xếp hạng.");
        return;
      }

      const uniqueIds = new Set(ids);
      if (uniqueIds.size < 4) {
        alert("Một người chỉ được đứng đúng 1 hạng. Vui lòng kiểm tra lại.");
        return;
      }

      const firstIndex  = r1 - 1;
      const secondIndex = r2 - 1;
      const thirdIndex  = r3 - 1;
      const fourthIndex = r4 - 1;

      // Người nhất búng Nhì/Ba/Bốn, có cấn trừ
      addFlick(firstIndex, secondIndex, 3);
      addFlick(firstIndex, thirdIndex, 4);
      addFlick(firstIndex, fourthIndex, 5);

      updateAllViews();
    }

    function resetCounts() {
      initMatrix();
      updateAllViews();
    }

    // Gắn sự kiện
    document.getElementById("initGameBtn").addEventListener("click", initPlayers);
    document.getElementById("firstHomeBtn").addEventListener("click", handleFirstHome);
    document
      .getElementById("kickHomeBtn")
      .addEventListener("click", function () {
        handleKick(true);
      });
    document
      .getElementById("kickNormalBtn")
      .addEventListener("click", function () {
        handleKick(false);
      });
    document
      .getElementById("resetCountsBtn")
      .addEventListener("click", resetCounts);
    document
      .getElementById("finishMatchBtn")
      .addEventListener("click", handleFinishMatch);
  </script>
</body>
</html>
